<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GWS Dashboard Setup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0B0F19; }
        .setup-card { background: rgba(25, 29, 41, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .details-marker::marker { color: #38BDF8; }
        .step { border-left: 2px solid #374151; padding-left: 1.5rem; margin-left: 0.5rem; }
        code { white-space: pre-wrap; word-break: break-all; }
    </style>
</head>
<body class="antialiased text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto">
        <div class="setup-card rounded-2xl p-8 md:p-12 shadow-2xl">
            <h1 class="text-3xl font-bold text-white mb-2 text-center">GWS Dashboard Setup</h1>
            <p class="text-slate-400 mb-8 text-center">Enter your Google Workspace and Service Account details.</p>

            <div id="errorMessage" class="hidden bg-red-900/50 border border-red-700 text-red-300 px-4 py-3 rounded-lg relative mb-6" role="alert">
                <strong class="font-bold">Authentication Failed!</strong>
                <span class="block sm:inline">Please double-check all credentials and ensure Domain-Wide Delegation is correctly configured.</span>
            </div>

            <form action="/login" method="POST" class="space-y-6">
                 <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="adminUser" class="block mb-2 text-sm font-medium text-slate-300">Admin User Email</label>
                        <input type="email" id="adminUser" name="adminUser" class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="superadmin@yourdomain.com" required>
                    </div>
                    <div>
                        <label for="domain" class="block mb-2 text-sm font-medium text-slate-300">Primary Domain</label>
                        <input type="text" id="domain" name="domain" class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="yourdomain.com" required>
                    </div>
                 </div>
                <hr class="border-slate-700 my-4">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="project_id" class="block mb-2 text-sm font-medium text-slate-300">Service Account Project ID</label>
                        <input type="text" id="project_id" name="project_id" class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="my-gws-project-12345" required>
                    </div>
                     <div>
                        <label for="client_id" class="block mb-2 text-sm font-medium text-slate-300">Client ID</label>
                        <input type="text" id="client_id" name="client_id" class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="123..." required>
                    </div>
                    <div>
                        <label for="private_key_id" class="block mb-2 text-sm font-medium text-slate-300">Private Key ID</label>
                        <input type="text" id="private_key_id" name="private_key_id" class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="abcdef123..." required>
                    </div>
                     <div>
                        <label for="client_email" class="block mb-2 text-sm font-medium text-slate-300">Client Email</label>
                        <input type="email" id="client_email" name="client_email" class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="...iam.gserviceaccount.com" required>
                    </div>
                </div>
                <div>
                    <label for="private_key" class="block mb-2 text-sm font-medium text-slate-300">Private Key</label>
                    <textarea id="private_key" name="private_key" rows="6" class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n" required></textarea>
                </div>

                <div class="flex items-center p-4 rounded-lg bg-slate-900/50 border border-slate-700">
                    <input id="useBigQuery" name="useBigQuery" type="checkbox" value="true" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                    <label for="useBigQuery" class="ml-3 text-sm font-medium text-gray-300">Enable BigQuery Integration (Optional)</label>
                </div>
                
                <div id="bigQueryFields" class="hidden space-y-6 pt-4 border-t border-slate-700">
                     <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label for="bigquery_project_id" class="block mb-2 text-sm font-medium text-slate-300">BigQuery Project ID</label>
                            <input type="text" id="bigquery_project_id" name="bigquery_project_id" class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="gcp-project-for-logs">
                             <p class="mt-1 text-xs text-slate-500">The project where logs are exported.</p>
                        </div>
                        <div>
                            <label for="bigquery_dataset_name" class="block mb-2 text-sm font-medium text-slate-300">BigQuery Dataset Name</label>
                            <input type="text" id="bigquery_dataset_name" name="bigquery_dataset_name" class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="gworkspace_logs">
                             <p class="mt-1 text-xs text-slate-500">The dataset created by the export.</p>
                        </div>
                     </div>
                </div>

                <button type="submit" class="w-full text-white bg-indigo-600 hover:bg-indigo-700 font-semibold rounded-lg text-sm px-5 py-3 text-center">Validate & Save Configuration</button>
            </form>

            <div class="mt-10">
                <details class="text-slate-300" open>
                    <summary class="cursor-pointer font-semibold text-lg hover:text-white details-marker">
                        How to get these credentials?
                    </summary>
                    <div class="mt-4 space-y-8 text-sm text-slate-400">
                        
                        <div class="step">
                            <h4 class="font-semibold text-slate-200 mb-2">üîë Prerequisites: Required Roles</h4>
                            <ul class="list-disc list-inside mt-2 space-y-1 pl-4">
                                <li><strong>Google Workspace Super Admin</strong> ‚Äì required to authorize domain-wide delegation.</li>
                                <li><strong>Google Cloud Project Owner/Editor</strong> ‚Äì required to create the project, enable APIs, and manage service accounts.</li>
                            </ul>
                        </div>

                        <div class="step">
                            <h4 class="font-semibold text-slate-200 mb-2">‚öôÔ∏è Step 1: Set Up Your Google Cloud Project</h4>
                            <p class="mt-2 font-semibold text-slate-300">Create a New Project</p>
                            <ul class="list-disc list-inside mt-2 space-y-1 pl-4">
                                <li>Go to the <a href="https://console.cloud.google.com/" target="_blank" class="text-cyan-400 hover:underline">Google Cloud Console</a>.</li>
                                <li>From the welcome screen, click <strong>New Project</strong>.</li>
                                <li>In the ‚ÄúNew Project‚Äù window, enter a project name (e.g., `gws-security-dashboard`).</li>
                                <li>Click <strong>Browse</strong> and select your organization. This is a critical step.</li>
                                <li>Click <strong>Create</strong>.</li>
                            </ul>
                            <img src="sop steps/img3.png" alt="New Project Screen" class="mt-3 rounded-md border border-slate-600 shadow-lg">

                            <p class="mt-4 font-semibold text-slate-300">Enable Required APIs</p>
                            <ul class="list-disc list-inside mt-2 space-y-1 pl-4">
                                <li>From the main menu (‚ò∞), go to <strong>APIs & Services ‚Üí Library</strong>.</li>
                                <li>Search for and enable the following APIs: Admin SDK API, Gmail API, Alert Center API, and (optionally) BigQuery API.</li>
                            </ul>
                            <img src="sop steps/img5.png" alt="API Library" class="mt-3 rounded-md border border-slate-600 shadow-lg">
                        </div>

                        <div class="step">
                            <h4 class="font-semibold text-slate-200 mb-2">üóùÔ∏è Step 2: Create the Service Account & Get Your Credentials</h4>
                             <p class="mt-2 font-semibold text-slate-300">Create the Service Account</p>
                            <ul class="list-disc list-inside mt-2 space-y-1 pl-4">
                                <li>Go to <strong>IAM & Admin ‚Üí Service Accounts ‚Üí Create Service Account</strong>.</li>
                                <li>Enter a name and description.</li>
                                <li>Assign role: <strong>Project ‚Üí Editor</strong> (or restrict further as needed).</li>
                                <li>Click <strong>Done</strong>.</li>
                            </ul>
                            <img src="sop steps/img7.png" alt="Create Service Account Form" class="mt-3 rounded-md border border-slate-600 shadow-lg">

                            <p class="mt-4 font-semibold text-slate-300">Get Your Two Credentials</p>
                             <ul class="list-disc list-inside mt-2 space-y-1 pl-4">
                                <li><strong>(a) The Key File (‚ÄúPassword‚Äù):</strong> Open the service account, go to the <strong>Keys</strong> tab, click <strong>Add key ‚Üí Create new key ‚Üí JSON</strong>, then <strong>Create</strong>. A `.json` file will download. Store it securely!</li>
                                <img src="sop steps/img10.png" alt="Keys Tab & Create Key Dialog" class="my-2 rounded-md border border-slate-600 shadow-lg">
                                <li><strong>(b) The Client ID (‚ÄúUsername‚Äù):</strong> Go to the <strong>Details</strong> tab and copy the long number labeled **Client ID**.</li>
                            </ul>
                        </div>
                        
                        <div class="step">
                            <h4 class="font-semibold text-slate-200 mb-2">üõ°Ô∏è Step 3: Authorize the Service Account in Google Workspace</h4>
                            <p class="mt-2 font-semibold text-slate-300">Navigate to Domain-Wide Delegation</p>
                            <ul class="list-disc list-inside mt-2 space-y-1 pl-4">
                                <li>In the <a href="https://admin.google.com/" target="_blank" class="text-cyan-400 hover:underline">Google Admin Console</a>, go to: <strong>Security ‚Üí Access and Data Control ‚Üí API Controls</strong>.</li>
                                <li>Scroll down and click <strong>Manage Domain Wide Delegation</strong>.</li>
                            </ul>
                             <img src="sop steps/img8.png" alt="API Controls Page" class="mt-3 rounded-md border border-slate-600 shadow-lg">

                            <p class="mt-4 font-semibold text-slate-300">Authorize Your Service Account</p>
                             <ul class="list-disc list-inside mt-2 space-y-1 pl-4">
                                 <li>Click <strong>Add new</strong>.</li>
                                 <li>Paste the <strong>Client ID</strong> from Step 2.</li>
                                 <li>In the <strong>OAuth Scopes</strong> field, paste the full, comma-separated list below.</li>
                                 <li>Click <strong>Authorize</strong>.</li>
                             </ul>
                            <code class="block bg-slate-900/50 p-3 mt-2 rounded-md text-xs text-slate-400">https://www.googleapis.com/auth/admin.directory.user.readonly,https://www.googleapis.com/auth/admin.directory.customer.readonly,https://www.googleapis.com/auth/userinfo.email,openid,https://www.googleapis.com/auth/userinfo.profile,https://www.googleapis.com/auth/admin.directory.user.security,https://www.googleapis.com/auth/admin.reports.usage.readonly,https://www.googleapis.com/auth/gmail.settings.basic,https://www.googleapis.com/auth/apps.alerts,https://www.googleapis.com/auth/admin.reports.audit.readonly,https://www.googleapis.com/auth/admin.directory.device.mobile.readonly,https://www.googleapis.com/auth/drive.readonly,https://www.googleapis.com/auth/drive.activity,https://www.googleapis.com/auth/admin.directory.rolemanagement.readonly,https://www.googleapis.com/auth/gmail.settings.sharing</code>
                            <img src="sop steps/img9.png" alt="Add New Client ID Dialog" class="mt-3 rounded-md border border-slate-600 shadow-lg">
                        </div>

                        <div class="step">
                             <h4 class="font-semibold text-slate-200 mb-2">üìä Step 4 (Optional): Configure BigQuery for Data Analysis</h4>
                             <p class="mt-2 font-semibold text-slate-300">What is BigQuery?</p>
                             <p>A cloud-scale database designed for storing and analyzing Google Workspace logs, providing permanent, searchable archives for advanced security analysis and reporting.</p>
                             
                             <div class="mt-4 p-3 rounded-lg bg-yellow-900/50 border border-yellow-700 text-yellow-300">
                                <p class="font-bold">‚ö†Ô∏è Workspace Plan Requirement</p>
                                <p class="mt-1">BigQuery export is available only for Google Workspace **Enterprise editions**. If your organization is on Business Starter/Standard/Plus, this feature may not be available.</p>
                             </div>

                             <p class="mt-4 font-semibold text-slate-300">How to Enable It</p>
                             <ul class="list-disc list-inside mt-2 space-y-1 pl-4">
                                 <li>Ensure the <strong>BigQuery API</strong> was enabled in Step 1.</li>
                                 <li>In Google Admin Console, go to: <strong>Reporting ‚Üí BigQuery Export</strong>.</li>
                                 <li>Link your Google Cloud Project ID. Google will create a <strong>Dataset Name</strong>.</li>
                                 <li>You‚Äôll need both the Project ID and Dataset Name for the dashboard.</li>
                             </ul>
                        </div>
                        
                         <div class="step">
                            <h4 class="font-semibold text-slate-200 mb-2">‚úÖ Setup Complete!</h4>
                             <p>At this point, your dashboard backend can:</p>
                             <ul class="list-disc list-inside mt-2 space-y-1 pl-4">
                                 <li>Authenticate using the downloaded <strong>.json key file</strong>.</li>
                                 <li>Fetch user data, MFA status, email settings, and alerts via APIs.</li>
                                 <li>(If on an Enterprise plan) Query historical logs via BigQuery for deeper analysis.</li>
                             </ul>
                        </div>
                        </div>
                </details>
            </div>
        </div>
    </div>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('error')) {
            document.getElementById('errorMessage').classList.remove('hidden');
        }

        const bqCheckbox = document.getElementById('useBigQuery');
        const bqFields = document.getElementById('bigQueryFields');
        const bqProjectId = document.getElementById('bigquery_project_id');
        const bqDatasetName = document.getElementById('bigquery_dataset_name');

        bqCheckbox.addEventListener('change', () => {
            if (bqCheckbox.checked) {
                bqFields.classList.remove('hidden');
                bqProjectId.required = true;
                bqDatasetName.required = true;
            } else {
                bqFields.classList.add('hidden');
                bqProjectId.required = false;
                bqDatasetName.required = false;
            }
        });
    </script>
</body>
</html>